<?php
header('Content-Type: application/json');
// Опционально ограничить CORS:
// header('Access-Control-Allow-Origin: https://zoneblast.cc');

$ids = isset($_GET['ids']) ? trim($_GET['ids']) : '';
if (!$ids) { echo json_encode([]); exit; }

// Путь к файлу с ключом — ОБЯЗАТЕЛЬНО ВНЕ public_html
$key_path = '/home/gdmspndbxu/steam_key.txt';
if (!file_exists($key_path)) { http_response_code(500); echo json_encode([]); exit; }
$steam_key = trim(file_get_contents($key_path));
if (!$steam_key) { http_response_code(500); echo json_encode([]); exit; }

// Простая файловая кеш‑схема
$cache_dir = sys_get_temp_dir() . '/steam_avatar_cache';
if (!is_dir($cache_dir)) @mkdir($cache_dir, 0700, true);
$cache_key = md5($ids);
$cache_file = $cache_dir . '/' . $cache_key . '.json';
$CACHE_TTL = 3600; // 1 час

if (file_exists($cache_file) && (time() - filemtime($cache_file)) < $CACHE_TTL) {
    echo file_get_contents($cache_file);
    exit;
}

// Запросим Steam Web API
$url = 'https://api.steampowered.com/ISteamUser/GetPlayerSummaries/v2/?key=' . urlencode($steam_key) . '&steamids=' . urlencode($ids);

// Попытка через file_get_contents, если allow_url_fopen отключён — через curl
$resp = @file_get_contents($url);
if ($resp === FALSE) {
    // используем cURL
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_TIMEOUT, 5);
    $resp = curl_exec($ch);
    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $err = curl_error($ch);
    curl_close($ch);
    if ($resp === false) {
        error_log('Steam proxy curl error: ' . $err);
        echo json_encode([]);
        exit;
    }
}

$json = json_decode($resp, true);
$out = [];
if (isset($json['response']['players']) && is_array($json['response']['players'])) {
    foreach ($json['response']['players'] as $p) {
        $out[$p['steamid']] = isset($p['avatarfull']) ? $p['avatarfull'] : (isset($p['avatar']) ? $p['avatar'] : null);
    }
}

// Запишем в кеш (без ключа)
$payload = json_encode($out);
@file_put_contents($cache_file, $payload);
echo $payload;
exit;